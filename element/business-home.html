<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/firebase-element/firebase-auth.html">
<link rel="import" href="../bower_components/firebase-element/firebase.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-swipeable-container/iron-swipeable-container.html">
<dom-module id="business-home">
  <template>
    <style>
    /*Not yet done*/
      .dismiss {
        --paper-card-header-color: pink;
      }
    </style>
    <firebase-auth
      auto-login
      redirect
      location="[[firebaseURL]]"
      provider="[[firebaseProvider]]"
      on-error="onFirebaseError"
      on-login="onFirebaseLogin"></firebase-auth>
    <paper-toast id="errorToast"></paper-toast>

    <div style="max-width: 600px; margin-top: 20px; margin-left: auto; margin-right: auto; @apply(--layout-vertical); @apply(--center-justified);">
      <template is="dom-repeat" items="{{items}}">
        <!--Card's ID is set based on item.uid-->
        <iron-swipeable-container>
        <paper-card id = "card{{item.uid}}" heading="{{item.title}}" style="width: 100%; margin-bottom: 16px;">
          <div class="card-content">{{item.message}}</div>
          <div class="card-actions">
            <paper-icon-button on-click="openNotification" icon="open-in-browser" title="Open"></paper-icon-button>
            <paper-icon-button id="dismissAction" on-click="dismissNotification" icon="clear" title="Open"></paper-icon-button>
          </div>
        </paper-card>
        </iron-swipeable-container>
      </template>
    </div>

  </template>

  <script>
    Polymer({
      is: 'business-home',
      properties: {
        userID: {
          type: String,
        }
      },
      listeners: {
        'iron-swipe': 'swipeToDismiss'
      },
      ready: function() {
        this.items = [];
        this.firebaseURL = 'https://realanyprint.firebaseio.com';
        this.firebaseProvider = 'anonymous';
      },
      updateItems: function(snapshot) {
        var app = document.querySelector('business-home');
        snapshot.forEach(function(childSnapshot) {
          var item = childSnapshot.val();
          console.log(item);
          if(item.done){
            return;
          }
          item.uid = childSnapshot.key();
          this.push('items', item);
        }.bind(this));
      },
      onFirebaseError: function(event) {
        this.$.errorToast.text = event.detail.message;
        this.$.errorToast.show();
      },
      onFirebaseLogin: function(event) {
        console.log(this.userID);
        console.log(this.firebaseURL + '/business/' + this.userID + '/content/notification');
        this.ref = new Firebase(this.firebaseURL + '/business/' + this.userID + '/content/notification');
        console.log("Logged in");
        var app = document.querySelector('business-home');
           this.ref.on('value', function(snapshot) {
             app.updateItems(snapshot);
           });
      },
      openNotification: function(event) {
        var app = document.querySelector('#app'); //To get the template section of businessprofile.php
        app.select = 1; //Set the page
      },
      swipeToDismiss: function(event){
        var cardAction = document.querySelector('#dismissAction');
        cardAction.click();
      },
      dismissNotification: function(event){
        // var cardID = '#card' + event.model.item.uid; //Each card's ID is set based on the item's uid
        // var card = document.querySelector(cardID);
        // console.log(cardID);
        // card.className = card.className + ' dismiss'; //NOTE: Still developing
        // console.log(card.className);
        this.ref.
        child(event.model.item.uid).
        update({done: true});
      }
    });
  </script>
</dom-module>
